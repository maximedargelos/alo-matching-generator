<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALO â€” Matching Generator</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');

  :root {
    --bg:        #f7f7f5;
    --white:     #ffffff;
    --border:    #e4e4e0;
    --border2:   #d0d0ca;
    --text:      #1a1a18;
    --text-dim:  #6b6b65;
    --text-dimmer: #b0b0aa;
    --accent:    #2d5be3;
    --accent-bg: #eef2fd;
    --accent-border: #c2d0f8;
    --danger:    #d63b3b;
    --danger-bg: #fdf0f0;
    --danger-border: #f5c5c5;
    --green:     #1a8a4a;
    --green-bg:  #edf7f2;
    --green-border: #b8e0ca;
    --orange:    #c45e00;
    --orange-bg: #fef5eb;
    --orange-border: #f5d9b0;
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'Plus Jakarta Sans', sans-serif;
    --radius: 8px;
    --shadow: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
    --shadow-md: 0 4px 12px rgba(0,0,0,.08), 0 2px 4px rgba(0,0,0,.04);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    font-size: 14px;
    line-height: 1.5;
  }

  .page {
    max-width: 780px;
    margin: 0 auto;
    padding: 48px 24px 80px;
  }

  /* â”€â”€ Header â”€â”€ */
  .header {
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .header-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 500;
    color: var(--accent);
    background: var(--accent-bg);
    border: 1px solid var(--accent-border);
    padding: 3px 9px;
    border-radius: 4px;
    letter-spacing: .06em;
    margin-bottom: 12px;
  }

  h1 {
    font-size: 24px;
    font-weight: 700;
    letter-spacing: -.02em;
    color: var(--text);
    margin-bottom: 5px;
  }

  .header-sub {
    font-size: 13px;
    color: var(--text-dim);
    line-height: 1.6;
  }

  .header-sub code {
    font-family: var(--mono);
    font-size: 11px;
    background: #eee;
    border: 1px solid var(--border2);
    padding: 1px 5px;
    border-radius: 3px;
    color: var(--accent);
  }

  /* â”€â”€ Card â”€â”€ */
  .card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 22px;
    margin-bottom: 14px;
    box-shadow: var(--shadow);
  }

  .section-label {
    font-size: 10px;
    font-weight: 600;
    font-family: var(--mono);
    color: var(--text-dimmer);
    letter-spacing: .1em;
    text-transform: uppercase;
    margin-bottom: 14px;
  }

  /* â”€â”€ Form â”€â”€ */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .form-group { display: flex; flex-direction: column; gap: 4px; }
  .form-group.full { grid-column: 1 / -1; }

  label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
  }

  label .req { color: var(--danger); margin-left: 2px; }

  .hint {
    font-size: 11px;
    color: var(--text-dimmer);
    font-family: var(--mono);
  }

  input, textarea {
    background: var(--white);
    border: 1px solid var(--border2);
    border-radius: var(--radius);
    padding: 8px 11px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    outline: none;
    width: 100%;
    transition: border-color .15s, box-shadow .15s;
  }

  input:focus, textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(45,91,227,.1);
  }

  input::placeholder, textarea::placeholder { color: var(--text-dimmer); }
  textarea { resize: vertical; min-height: 66px; line-height: 1.5; }

  .divider { height: 1px; background: var(--border); margin: 18px 0; }

  /* â”€â”€ Toggle â”€â”€ */
  .toggle-row {
    display: flex;
    align-items: flex-start;
    gap: 11px;
    padding: 12px 14px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: border-color .15s, background .15s;
    user-select: none;
  }

  .toggle-row:hover { border-color: var(--border2); }
  .toggle-row.active { background: var(--danger-bg); border-color: var(--danger-border); }

  .toggle-box {
    width: 15px; height: 15px;
    border: 2px solid var(--border2);
    border-radius: 3px;
    flex-shrink: 0;
    margin-top: 2px;
    display: flex; align-items: center; justify-content: center;
    background: white;
    transition: all .15s;
  }

  .toggle-row.active .toggle-box { background: var(--danger); border-color: var(--danger); }
  .toggle-row.active .toggle-box::after {
    content: '';
    width: 7px; height: 4px;
    border-left: 2px solid white;
    border-bottom: 2px solid white;
    transform: rotate(-45deg) translateY(-1px);
    display: block;
  }

  .tl { font-size: 13px; font-weight: 600; color: var(--text); }
  .toggle-row.active .tl { color: var(--danger); }
  .td { font-size: 11px; color: var(--text-dim); margin-top: 2px; line-height: 1.5; }

  /* â”€â”€ Secteurs â”€â”€ */
  .check-grid { display: flex; flex-wrap: wrap; gap: 7px; }

  .check-item {
    display: flex; align-items: center; gap: 7px;
    padding: 7px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    transition: all .15s;
    user-select: none;
    font-size: 12px; font-weight: 500;
  }

  .check-item:hover { border-color: var(--border2); background: white; }
  .check-item.active { background: var(--accent-bg); border-color: var(--accent-border); color: var(--accent); }

  .check-box {
    width: 13px; height: 13px;
    border: 2px solid var(--border2);
    border-radius: 3px;
    flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    background: white; transition: all .15s;
  }

  .check-item.active .check-box { background: var(--accent); border-color: var(--accent); }
  .check-item.active .check-box::after {
    content: '';
    width: 7px; height: 4px;
    border-left: 2px solid white;
    border-bottom: 2px solid white;
    transform: rotate(-45deg) translateY(-1px);
    display: block;
  }

  /* â”€â”€ Boutons â”€â”€ */
  .btn {
    display: inline-flex; align-items: center; gap: 8px;
    background: var(--accent); color: white;
    border: none; border-radius: var(--radius);
    padding: 10px 20px;
    font-family: var(--sans); font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all .15s; letter-spacing: -.01em;
  }

  .btn:hover { background: #2449c4; box-shadow: var(--shadow-md); }
  .btn:active { transform: scale(.99); }

  .btn-ghost {
    display: inline-flex; align-items: center; gap: 6px;
    background: none; border: 1px solid var(--border2); color: var(--text-dim);
    border-radius: 6px; padding: 6px 11px;
    font-family: var(--sans); font-size: 11px; font-weight: 500;
    cursor: pointer; transition: all .15s;
  }

  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }

  .btn-copy-sel {
    display: none; align-items: center; gap: 7px;
    background: var(--green); color: white;
    border: none; border-radius: 6px; padding: 7px 14px;
    font-family: var(--sans); font-size: 12px; font-weight: 600;
    cursor: pointer; transition: all .15s;
  }

  .btn-copy-sel.visible { display: inline-flex; }
  .btn-copy-sel:hover { background: #166b3a; }

  /* â”€â”€ RÃ©sultats â”€â”€ */
  #results { display: none; margin-top: 22px; }

  .results-bar {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 10px; gap: 10px; flex-wrap: wrap;
  }

  .results-bar-left  { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .results-bar-right { display: flex; align-items: center; gap: 8px; }

  .pill {
    font-family: var(--mono); font-size: 10px; font-weight: 500;
    padding: 3px 8px; border-radius: 4px;
  }

  .pill-blue   { background: var(--accent-bg); color: var(--accent); border: 1px solid var(--accent-border); }
  .pill-gray   { background: var(--bg); color: var(--text-dim); border: 1px solid var(--border); }

  .ambiguity-notice {
    display: none; gap: 8px; padding: 10px 13px;
    background: var(--danger-bg); border: 1px solid var(--danger-border);
    border-radius: var(--radius);
    font-size: 12px; color: var(--danger); margin-bottom: 10px; line-height: 1.5;
  }

  .ambiguity-notice.show { display: flex; }

  /* â”€â”€ Liste â”€â”€ */
  .chains-wrap {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  .chains-inner { max-height: 500px; overflow-y: auto; }
  .chains-inner::-webkit-scrollbar { width: 4px; }
  .chains-inner::-webkit-scrollbar-track { background: var(--bg); }
  .chains-inner::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  .chain-item {
    display: flex; align-items: center; gap: 9px;
    padding: 8px 13px;
    border-bottom: 1px solid var(--border);
    transition: background .1s;
    cursor: pointer; user-select: none;
  }

  .chain-item:last-child { border-bottom: none; }
  .chain-item:hover { background: var(--bg); }
  .chain-item.selected { background: var(--accent-bg); }
  .chain-item.selected:hover { background: #e4ecfc; }

  .sel-box {
    width: 14px; height: 14px;
    border: 2px solid var(--border2);
    border-radius: 3px; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    background: white; transition: all .12s;
  }

  .chain-item.selected .sel-box { background: var(--accent); border-color: var(--accent); }
  .chain-item.selected .sel-box::after {
    content: '';
    width: 7px; height: 4px;
    border-left: 2px solid white;
    border-bottom: 2px solid white;
    transform: rotate(-45deg) translateY(-1px);
    display: block;
  }

  .chain-scope {
    font-family: var(--mono); font-size: 9px; font-weight: 500;
    padding: 2px 6px; border-radius: 3px;
    white-space: nowrap; flex-shrink: 0; letter-spacing: .04em;
  }

  .scope-name       { background: var(--accent-bg); color: var(--accent); border: 1px solid var(--accent-border); }
  .scope-name-ville { background: var(--green-bg);  color: var(--green);  border: 1px solid var(--green-border); }
  .scope-name-cp    { background: var(--orange-bg); color: var(--orange); border: 1px solid var(--orange-border); }
  .scope-special    { background: #fef5ff; color: #8b3cbf; border: 1px solid #e0b8f5; }

  .chain-expr { flex: 1; display: flex; align-items: center; gap: 3px; min-width: 0; }
  .chain-delim { font-family: var(--mono); font-size: 11px; color: var(--text-dimmer); white-space: nowrap; flex-shrink: 0; }
  .chain-core  { font-family: var(--mono); font-size: 12px; font-weight: 500; color: var(--text); word-break: break-all; }
  .chain-item.selected .chain-core { color: var(--accent); }

  .icopy {
    flex-shrink: 0; background: none; border: none;
    color: var(--text-dimmer); cursor: pointer;
    padding: 3px; border-radius: 3px;
    transition: color .12s; display: flex; align-items: center;
    opacity: 0;
  }

  .chain-item:hover .icopy { opacity: 1; }
  .icopy:hover { color: var(--accent); }

  .select-bar {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 13px;
    background: var(--bg); border-bottom: 1px solid var(--border);
    font-size: 12px; color: var(--text-dim);
  }

  .select-bar a { color: var(--accent); text-decoration: none; cursor: pointer; font-weight: 500; }
  .select-bar a:hover { text-decoration: underline; }

  /* â”€â”€ Test â”€â”€ */
  #test-section { display: none; margin-top: 14px; }

  .score-row {
    display: flex; align-items: center; gap: 12px;
    padding: 11px 15px;
    background: var(--white); border: 1px solid var(--border);
    border-radius: var(--radius); margin-bottom: 9px;
    box-shadow: var(--shadow); font-size: 12px;
  }

  .score-label { color: var(--text-dim); font-size: 11px; white-space: nowrap; }
  .score-bar { flex: 1; height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
  .score-fill { height: 100%; border-radius: 3px; transition: width .4s ease; }
  .score-val  { font-weight: 700; font-size: 13px; white-space: nowrap; }
  .score-cnt  { color: var(--text-dimmer); font-size: 11px; white-space: nowrap; }

  .test-item {
    display: flex; align-items: center; gap: 9px;
    padding: 7px 12px; border-radius: 6px; margin-bottom: 3px;
    font-family: var(--mono); font-size: 11px;
  }

  .ti-match { background: var(--green-bg); border: 1px solid var(--green-border); }
  .ti-miss  { background: var(--bg);       border: 1px solid var(--border); color: var(--text-dim); }
  .ti-badge { font-size: 9px; font-weight: 700; white-space: nowrap; flex-shrink: 0; }
  .tb-match { color: var(--green); }
  .tb-miss  { color: var(--danger); }
  .ti-chain { color: var(--text-dimmer); font-size: 10px; max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  /* â”€â”€ Toast â”€â”€ */
  .toast {
    position: fixed; bottom: 24px; right: 24px;
    background: var(--text); color: white;
    padding: 8px 15px; border-radius: 7px;
    font-family: var(--sans); font-size: 12px; font-weight: 500;
    transform: translateY(50px); opacity: 0;
    transition: all .25s; z-index: 100;
    box-shadow: var(--shadow-md);
  }

  .toast.show { transform: translateY(0); opacity: 1; }

  @media(max-width:560px){
    .form-grid { grid-template-columns: 1fr; }
    .form-group.full { grid-column: 1; }
  }
</style>
</head>
<body>
<div class="page">

  <div class="header">
    <div class="header-tag">ALO Â· Account-Linked Offers</div>
    <h1>Matching Generator</h1>
    <p class="header-sub">
      GÃ©nÃ¨re les chaÃ®nes Ã  paramÃ©trer dans ton systÃ¨me, sous la forme <code>(^| )CHAINE($| )</code>.<br>
      SÃ©lectionne les chaÃ®nes pertinentes avant de les copier.
    </p>
  </div>

  <div class="card">
    <div class="section-label">Informations du marchand</div>
    <div class="form-grid">

      <div class="form-group">
        <label>Nom commercial<span class="req">*</span></label>
        <input type="text" id="nom_commercial" placeholder="ex : Les Vins du Littoral" />
      </div>

      <div class="form-group">
        <label>Raison(s) sociale(s)</label>
        <textarea id="raison_sociale" placeholder="ex : SARL THOMAL&#10;Une par ligne si plusieurs"></textarea>
        <span class="hint">Nom dÃ©clarÃ© au rÃ©seau CB</span>
      </div>

      <div class="form-group">
        <label>Ville<span class="req">*</span></label>
        <input type="text" id="ville" placeholder="ex : Frethun" />
      </div>

      <div class="form-group">
        <label>Code postal</label>
        <input type="text" id="cp" placeholder="ex : 62185" maxlength="5" />
        <span class="hint">GÃ©nÃ¨re des variantes avec le numÃ©ro de dÃ©partement</span>
      </div>

    </div>

    <div class="divider"></div>
    <div class="section-label">UnicitÃ© du nom commercial</div>

    <div class="toggle-row" id="ambiguity-toggle" onclick="toggleAmbiguity()">
      <div class="toggle-box"></div>
      <div>
        <div class="tl">D'autres commerces portent le mÃªme nom en France</div>
        <div class="td">Si activÃ© : aucune chaÃ®ne sans ville ou code dÃ©partement ne sera gÃ©nÃ©rÃ©e.</div>
      </div>
    </div>

    <div class="divider"></div>
    <div class="section-label">Options sectorielles</div>

    <div class="check-grid">
      <div class="check-item" data-value="station"><div class="check-box"></div>â›½ Station-service</div>
      <div class="check-item" data-value="restauration_rapide"><div class="check-box"></div>ğŸ” Restauration rapide</div>
      <div class="check-item" data-value="ecommerce"><div class="check-box"></div>ğŸ›’ E-commerce / click&collect</div>
    </div>
  </div>

  <div class="card">
    <div class="section-label">Tester sur des libellÃ©s rÃ©els</div>
    <div class="form-group">
      <label>Un libellÃ© par ligne</label>
      <textarea id="test_labels" style="min-height:76px" placeholder="PAIEMENT PAR CARTE X4083 LES VINS DU LITT FRETH 12/03&#10;281225 CB****1234 VINS DU LITT 62FRETHUN"></textarea>
    </div>
  </div>

  <button class="btn" onclick="generate()">
    <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M3 8h10M9 4l4 4-4 4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    GÃ©nÃ©rer les chaÃ®nes
  </button>

  <div id="results">

    <div class="ambiguity-notice" id="ambiguity-notice">
      <span>âš </span>
      <span>Nom ambigu activÃ© â€” seules les chaÃ®nes incluant la ville ou le dÃ©partement sont affichÃ©es.</span>
    </div>

    <div class="results-bar">
      <div class="results-bar-left">
        <span class="section-label" style="margin:0">ChaÃ®nes gÃ©nÃ©rÃ©es</span>
        <span class="pill pill-blue" id="stat-total">0 chaÃ®nes</span>
        <span class="pill pill-gray" id="stat-sel" style="display:none"></span>
      </div>
      <div class="results-bar-right">
        <button class="btn-ghost" onclick="copyAll()">
          <svg width="11" height="11" viewBox="0 0 16 16" fill="none"><rect x="4" y="4" width="9" height="10" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M3 3v9.5A1.5 1.5 0 011.5 11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          Tout copier
        </button>
        <button class="btn-copy-sel" id="btn-copy-sel" onclick="copySelected()">
          <svg width="11" height="11" viewBox="0 0 16 16" fill="none"><rect x="4" y="4" width="9" height="10" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M3 3v9.5A1.5 1.5 0 011.5 11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          Copier la sÃ©lection
        </button>
      </div>
    </div>

    <div class="chains-wrap">
      <div class="select-bar">
        <span>Coche les chaÃ®nes Ã  paramÃ©trer</span>
        <a onclick="selectAll()">Tout sÃ©lectionner</a>
        <a onclick="selectNone()">Tout dÃ©sÃ©lectionner</a>
      </div>
      <div class="chains-inner" id="chains-list"></div>
    </div>
  </div>

  <div id="test-section">
    <div class="results-bar" style="margin-top:0">
      <span class="section-label" style="margin:0">Test de matching</span>
    </div>
    <div class="score-row" id="score-row"></div>
    <div id="test-results"></div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ Ã‰tat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let isAmbiguous = false;
let generatedChains = [];

function toggleAmbiguity() {
  isAmbiguous = !isAmbiguous;
  document.getElementById('ambiguity-toggle').classList.toggle('active', isAmbiguous);
}

document.querySelectorAll('.check-item').forEach(item => {
  item.addEventListener('click', () => item.classList.toggle('active'));
});

// â”€â”€â”€ Normalisation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function norm(str) {
  return str.toUpperCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .replace(/[''`]/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}

function dept(cp) {
  if (!cp) return null;
  const m = cp.replace(/\s/g,'').match(/^(\d{2})/);
  return m ? m[1] : null;
}

function stripArticles(s) {
  for (const a of ['LE ','LA ','LES ','L ','DU ','DE LA ','DE L ','DES ','UN ','UNE ','AU '])
    if (s.startsWith(a)) return s.slice(a.length).trim();
  return null;
}

// Mots purement gÃ©nÃ©riques â€” un fragment ne doit pas se terminer sur l'un d'eux
const STOP_WORDS = new Set(['LE','LA','LES','L','DU','DE','DES','UN','UNE','AU','AUX','ET','EN','A','AU','PAR','SUR','SOUS']);

function isMeaningfulWord(w) {
  return !STOP_WORDS.has(w) && w.length >= 2;
}

// â”€â”€â”€ Troncatures â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RÃ¨gle : on ne gÃ©nÃ¨re jamais un fragment qui se termine par un stop word,
// et on ne gÃ©nÃ¨re jamais un fragment d'un seul mot.
function wordTruncations(name) {
  const result = new Set([name]);
  const words = name.split(' ').filter(Boolean);

  // Sous-sÃ©quences de mots entiers depuis le dÃ©but
  // Minimum 2 mots, et le dernier mot doit Ãªtre significatif
  for (let n = 2; n < words.length; n++) {
    const lastWord = words[n - 1];
    if (isMeaningfulWord(lastWord)) {
      const fragment = words.slice(0, n).join(' ');
      if (fragment !== name) result.add(fragment);
    }
  }

  // Troncatures brutes aux longueurs typiques bancaires (les banques coupent n'importe oÃ¹)
  for (const lim of [20, 18, 17, 16, 15, 14, 13, 12]) {
    if (name.length <= lim) continue;
    const brute = name.slice(0, lim).trim();
    // N'ajouter que si la troncature brute contient au moins 2 mots
    if (brute.length >= 4 && brute.includes(' ')) result.add(brute);
  }

  return [...result];
}

function villeTruncs(villeN) {
  const result = new Set([villeN]);
  const words = villeN.split(' ').filter(Boolean);
  // Mots entiers pour la ville
  for (let n = 1; n < words.length; n++) {
    const t = words.slice(0, n).join(' ');
    if (t.length >= 3) result.add(t);
  }
  // Troncatures brutes
  for (const lim of [12, 10, 8, 7]) {
    if (villeN.length <= lim) continue;
    const brute = villeN.slice(0, lim).trim();
    if (brute.length >= 3) result.add(brute);
  }
  return [...result];
}

// â”€â”€â”€ DÃ©duplication par inclusion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Si une chaÃ®ne A est sous-chaÃ®ne d'une chaÃ®ne B, B est redondante.
function deduplicateByInclusion(chains) {
  const sorted = [...chains].sort((a, b) => a.chain.length - b.chain.length);
  const kept = [];
  for (const item of sorted) {
    const dominated = kept.some(k => item.chain.includes(k.chain));
    if (!dominated) kept.push(item);
  }
  return kept;
}

// â”€â”€â”€ GÃ©nÃ©rateur â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateChains({ nomCommercial, raisonSociales, ville, cp, secteurs, ambiguous }) {
  const villeN  = norm(ville);
  const deptNum = dept(cp);
  const vt      = villeTruncs(villeN);

  const baseNames = new Set();
  const addName = n => {
    if (!n || n.length < 3) return;
    baseNames.add(n);
    const noA = stripArticles(n);
    if (noA && noA !== n && noA.length >= 3) baseNames.add(noA);
  };

  addName(norm(nomCommercial));
  for (const rs of raisonSociales) addName(norm(rs));

  const seen = new Set();
  const results = [];

  function add(chain, scope) {
    const key = chain.trim();
    if (!key || seen.has(key)) return;
    seen.add(key);
    results.push({ chain: key, scope, selected: false });
  }

  for (const baseName of baseNames) {
    const nt = wordTruncations(baseName);

    for (const n of nt) {
      if (!ambiguous) add(n, 'name');

      for (const v of vt) {
        add(`${n} ${v}`, 'name+ville');
        add(`${v} ${n}`, 'name+ville');
      }

      if (deptNum) {
        for (const v of vt) {
          add(`${n} ${deptNum}${v}`,  'name+cp');
          add(`${n} ${deptNum} ${v}`, 'name+cp');
          add(`${deptNum} ${v} ${n}`, 'name+cp');
        }
        add(`${n} ${deptNum}`, 'name+cp');
        add(`${deptNum} ${n}`, 'name+cp');
      }
    }
  }

  if (secteurs.includes('station')) {
    for (const bn of baseNames)
      for (const n of wordTruncations(bn)) {
        add(`DAC ${n}`, 'special');
        add(`CERTAS ${n}`, 'special');
      }
  }
  if (secteurs.includes('restauration_rapide')) {
    for (const bn of baseNames)
      for (const n of wordTruncations(bn)) {
        add(`PSI ${n}`, 'special');
        add(`SUMUP ${n}`, 'special');
      }
  }
  if (secteurs.includes('ecommerce')) {
    for (const bn of baseNames)
      for (const n of wordTruncations(bn))
        add(`UEP*${n}`, 'special');
  }

  const deduped = deduplicateByInclusion(results);

  const order = { 'name':0, 'name+ville':1, 'name+cp':2, 'special':3 };
  deduped.sort((a, b) => {
    const d = (order[a.scope]??9) - (order[b.scope]??9);
    return d !== 0 ? d : a.chain.length - b.chain.length;
  });

  return deduped;
}

// â”€â”€â”€ Rendu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCOPE_CFG = {
  'name':       { label:'NOM SEUL',    cls:'scope-name' },
  'name+ville': { label:'NOM + VILLE', cls:'scope-name-ville' },
  'name+cp':    { label:'NOM + CP',    cls:'scope-name-cp' },
  'special':    { label:'SPÃ‰CIAL',     cls:'scope-special' },
};

function generate() {
  const nomCommercial  = document.getElementById('nom_commercial').value.trim();
  const ville          = document.getElementById('ville').value.trim();
  if (!nomCommercial || !ville) { toast('âš  Nom commercial et ville requis'); return; }

  const rsRaw          = document.getElementById('raison_sociale').value.trim();
  const raisonSociales = rsRaw ? rsRaw.split('\n').map(s=>s.trim()).filter(Boolean) : [];
  const cp             = document.getElementById('cp').value.trim();
  const secteurs       = [...document.querySelectorAll('.check-item.active')].map(el=>el.dataset.value);
  const testLabels     = document.getElementById('test_labels').value.trim();

  generatedChains = generateChains({ nomCommercial, raisonSociales, ville, cp, secteurs, ambiguous: isAmbiguous });

  document.getElementById('ambiguity-notice').classList.toggle('show', isAmbiguous);
  document.getElementById('stat-total').textContent = `${generatedChains.length} chaÃ®nes`;

  renderChains();
  updateSelStats();

  document.getElementById('results').style.display = 'block';
  if (testLabels) runTest(generatedChains, testLabels);
  else document.getElementById('test-section').style.display = 'none';

  document.getElementById('results').scrollIntoView({ behavior:'smooth', block:'start' });
}

function renderChains() {
  const list = document.getElementById('chains-list');
  list.innerHTML = '';
  for (let i = 0; i < generatedChains.length; i++) {
    const { chain, scope, selected } = generatedChains[i];
    const cfg = SCOPE_CFG[scope] || { label: scope, cls:'scope-special' };
    const item = document.createElement('div');
    item.className = 'chain-item' + (selected ? ' selected' : '');
    item.dataset.idx = i;
    item.innerHTML = `
      <div class="sel-box"></div>
      <span class="chain-scope ${cfg.cls}">${cfg.label}</span>
      <div class="chain-expr">
        <span class="chain-delim">(^|&nbsp;)</span>
        <span class="chain-core">${escH(chain)}</span>
        <span class="chain-delim">($|&nbsp;)</span>
      </div>
      <button class="icopy" onclick="event.stopPropagation();copyText('(^| )${escA(chain)}($| )')" title="Copier">
        <svg width="12" height="12" viewBox="0 0 16 16" fill="none"><rect x="4" y="4" width="9" height="10" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M3 3v9.5A1.5 1.5 0 011.5 11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
    `;
    item.addEventListener('click', () => toggleSelect(i));
    list.appendChild(item);
  }
}

function toggleSelect(idx) {
  generatedChains[idx].selected = !generatedChains[idx].selected;
  document.querySelector(`.chain-item[data-idx="${idx}"]`).classList.toggle('selected', generatedChains[idx].selected);
  updateSelStats();
}

function selectAll()  { generatedChains.forEach(c => c.selected = true);  renderChains(); updateSelStats(); }
function selectNone() { generatedChains.forEach(c => c.selected = false); renderChains(); updateSelStats(); }

function updateSelStats() {
  const n = generatedChains.filter(c => c.selected).length;
  const pill = document.getElementById('stat-sel');
  const btn  = document.getElementById('btn-copy-sel');
  if (n > 0) {
    pill.textContent = `${n} sÃ©lectionnÃ©e${n>1?'s':''}`;
    pill.style.display = 'inline-flex';
    btn.classList.add('visible');
    btn.textContent = `Copier la sÃ©lection (${n})`;
  } else {
    pill.style.display = 'none';
    btn.classList.remove('visible');
  }
}

function runTest(chains, labelsText) {
  const labels = labelsText.split('\n').map(s=>s.trim()).filter(Boolean);
  const results = [];

  for (const label of labels) {
    const labelN = norm(label);
    let matched = false, matchedChain = null;
    for (const { chain } of chains) {
      try {
        if (new RegExp('(^|\\s)' + escRe(chain) + '(\\s|$)', 'i').test(labelN)) {
          matched = true; matchedChain = chain; break;
        }
      } catch(e) {}
    }
    results.push({ label, matched, matchedChain });
  }

  const n   = results.filter(r => r.matched).length;
  const pct = Math.round(n / results.length * 100);
  const col = pct > 80 ? 'var(--green)' : pct > 50 ? 'var(--orange)' : 'var(--danger)';

  document.getElementById('score-row').innerHTML = `
    <span class="score-label">TAUX DE MATCH</span>
    <div class="score-bar"><div class="score-fill" style="width:${pct}%;background:${col}"></div></div>
    <span class="score-val" style="color:${col}">${pct}%</span>
    <span class="score-cnt">(${n} / ${results.length} libellÃ©s)</span>
  `;

  const container = document.getElementById('test-results');
  container.innerHTML = '';
  for (const { label, matched, matchedChain } of results) {
    const div = document.createElement('div');
    div.className = `test-item ${matched ? 'ti-match' : 'ti-miss'}`;
    div.innerHTML = `
      <span class="ti-badge ${matched?'tb-match':'tb-miss'}">${matched?'âœ“ MATCH':'âœ— RATÃ‰'}</span>
      <span style="flex:1">${escH(label)}</span>
      ${matched ? `<span class="ti-chain" title="${escA(matchedChain)}">â†’ ${escH(matchedChain)}</span>` : ''}
    `;
    container.appendChild(div);
  }

  document.getElementById('test-section').style.display = 'block';
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escRe(s) { return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function escH(s)  { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escA(s)  { return s.replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

function copyText(t) { navigator.clipboard.writeText(t).then(() => toast('CopiÃ© !')); }

function copyAll() {
  const lines = generatedChains.map(c => `(^| )${c.chain}($| )`);
  navigator.clipboard.writeText(lines.join('\n')).then(() => toast(`${lines.length} chaÃ®nes copiÃ©es`));
}

function copySelected() {
  const sel = generatedChains.filter(c => c.selected);
  if (!sel.length) { toast('Aucune chaÃ®ne sÃ©lectionnÃ©e'); return; }
  const lines = sel.map(c => `(^| )${c.chain}($| )`);
  navigator.clipboard.writeText(lines.join('\n')).then(() => toast(`${lines.length} chaÃ®ne${lines.length>1?'s':''} copiÃ©e${lines.length>1?'s':''}`));
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

document.addEventListener('keydown', e => { if (e.key === 'Enter' && e.ctrlKey) generate(); });
</script>
</body>
</html>
